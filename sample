#lang denxi

(define-runtime-path dependencies
  "dependencies")

(define (fetch-digest content-url)
  (define digest-url
    (string-append content-url ".sha256"))
  (define digest-source
    (http-source digest-url 0))
  (define digest-policy
    (struct-copy transfer-policy zero-trust-transfer-policy
                 [max-size 40]))
  (machine-fetch digest-source
                 (λ (in est-size)
                   (define-values (i o) (make-pipe))
                   (transfer i o est-size digest-policy)
                   (port->bytes i))))


(define (artifact-static.typeand.click name)
  (define content-url (string-append "http://static.typeand.click/" name ".tar.gz"))
  (define signature-url (string-append digest-url ".sig"))
  (define content-source (http-source content-url 0))
  (define signature-source (http-source signature-url 0))
  (mdo from-bytes := (machine-fetch (curry govern-tap content-policy))
       digest := (fetch-digest content-url)
       signature := (machine-fetch (λ (in est) signature-policy))
  )
